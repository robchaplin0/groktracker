<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fafaf9;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-sec: #6b7280;
            --color-border: #e5e7eb;
            --color-hover: #f3f4f6;
            --color-accent: #10b981;
            --color-accent-light: #d1fae5;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --transition: all 0.18s ease;
        }

        [data-theme="dark"] {
            --color-bg: #111827;
            --color-surface: #1f2937;
            --color-text: #f3f4f6;
            --color-text-sec: #9ca3af;
            --color-border: #374151;
            --color-hover: #374151;
            --color-accent: #34d399;
            --color-accent-light: #064e3b;
            --color-success: #34d399;
            --color-warning: #fbbf24;
            --color-danger: #f87171;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.6;
            transition: background 0.4s, color 0.4s;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            background: var(--color-surface);
            min-height: 100vh;
            border-left: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
        }

        .header {
            padding: 64px 32px 40px;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 3.2rem;
            font-weight: 300;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .subtitle { color: var(--color-text-sec); font-size: 1.05rem; }

        .client-name {
            margin: 1.5rem 0;
            display: inline-block;
            padding: 0.5rem 1rem;
            background: var(--color-accent-light);
            color: var(--color-accent);
            border-radius: 999px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 32px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-surface);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .theme-toggle, .today-btn {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .theme-toggle:hover, .today-btn:hover { background: var(--color-hover); }

        .content { padding: 32px; }

        .date-nav {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 2rem 0 2.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .date-nav button {
            padding: 10px 18px;
            border: 1px solid var(--color-border);
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .date-nav button:disabled { opacity: 0.4; cursor: not-allowed; }

        .current-date {
            font-weight: 600;
            font-size: 1.1rem;
            min-width: 220px;
            text-align: center;
        }

        .habits-list { margin: 2rem 0; }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 1.1rem 0;
            border-bottom: 1px solid var(--color-border);
            transition: var(--transition);
            user-select: none;
        }

        .habit-item:hover { background: var(--color-hover); }

        .habit-check-area {
            position: relative;
            width: 28px;
            height: 28px;
            margin-right: 1.25rem;
            flex-shrink: 0;
        }

        .habit-check { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

        .checkmark {
            position: absolute;
            inset: 0;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            transition: var(--transition);
        }

        .habit-check:checked + .checkmark {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .checkmark::after {
            content: "";
            position: absolute;
            display: none;
            left: 8px; top: 4px;
            width: 8px; height: 14px;
            border: solid white;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }

        .habit-check:checked + .checkmark::after { display: block; }

        .partial-btn {
            margin-left: 8px;
            padding: 4px 10px;
            font-size: 0.8rem;
            border: 1px solid var(--color-warning);
            background: transparent;
            border-radius: 6px;
            color: var(--color-warning);
            cursor: pointer;
        }

        .partial-btn.active {
            background: var(--color-warning);
            color: white;
        }

        .habit-name { flex: 1; font-size: 1.1rem; }

        .habit-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .habit-item:hover .habit-actions { opacity: 1; }

        .move-btn, .delete-btn {
            background: none;
            border: none;
            color: var(--color-text-sec);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 6px;
        }

        .delete-btn:hover { color: var(--color-danger); }

        .add-habit-form {
            display: flex;
            gap: 12px;
            margin: 2.5rem 0;
        }

        .add-habit-input {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--color-border);
            border-radius: 10px;
            font-size: 1rem;
        }

        .add-habit-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.15);
        }

        .char-count {
            font-size: 0.8rem;
            color: var(--color-text-sec);
            text-align: right;
            margin-top: 4px;
        }

        .add-btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 0 28px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-btn:hover { background: #059669; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
            padding: 2rem 0;
            border-top: 1px solid var(--color-border);
        }

        .stat-box {
            text-align: center;
            padding: 1.2rem;
            background: var(--color-hover);
            border-radius: 12px;
        }

        .stat-number {
            font-family: 'Crimson Pro', serif;
            font-size: 2.8rem;
            font-weight: 400;
            line-height: 1;
        }

        .stat-label { color: var(--color-text-sec); font-size: 0.9rem; margin-top: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }

        .motivation {
            text-align: center;
            font-size: 1.1rem;
            color: var(--color-success);
            margin: 1.5rem 0;
            min-height: 1.6em;
            font-style: italic;
        }

        .undo-toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.4s, transform 0.4s;
            z-index: 100;
        }

        .undo-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }

        .undo-toast button {
            margin-left: 16px;
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
        }

        @media (max-width: 640px) {
            .header { padding: 48px 20px 32px; }
            h1 { font-size: 2.6rem; }
            .content { padding: 20px; }
            .add-habit-form { flex-direction: column; }
            .add-btn { width: 100%; padding: 14px; }
            .date-nav { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="toolbar">
        <button class="theme-toggle" id="themeToggle">üåô Dark</button>
        <div class="client-name" id="clientName"></div>
    </div>

    <div class="header">
        <h1>Daily Habits</h1>
        <p class="subtitle">Small steps. Big change.</p>
    </div>

    <div class="content">

        <div class="date-nav">
            <button onclick="changeDate(-1)">‚Üê Previous</button>
            <div class="current-date" id="currentDate"></div>
            <button class="today-btn" onclick="goToToday()">Today</button>
            <button onclick="changeDate(1)" id="nextBtn">Next ‚Üí</button>
        </div>

        <div class="habits-section">
            <h2 style="text-align:center; margin-bottom:1.5rem; font-family:'Crimson Pro',serif; font-weight:400; font-size:1.8rem;">
                Today's Habits
            </h2>

            <div class="habits-list" id="habitsList"></div>

            <div class="add-habit-form">
                <div style="flex:1;">
                    <input type="text" id="newHabit" class="add-habit-input" placeholder="New habit..." maxlength="80">
                    <div class="char-count" id="charCount">0 / 80</div>
                </div>
                <button class="add-btn" onclick="addHabit()">Add</button>
            </div>
        </div>

        <div class="stats" id="stats"></div>

        <div class="motivation" id="motivationMsg"></div>
    </div>
</div>

<div class="undo-toast" id="undoToast">
    Action undone? <button id="undoBtn">Undo</button>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONFIG & STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; // still placeholder

let currentDate = new Date();
currentDate.setHours(0,0,0,0);

let clientId = new URLSearchParams(location.search).get('client') || '';
let clientName = clientId ? clientId.split('-').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ') : '';

let lastAction = null; // {type, habitId, dateKey, prevValue}
const UNDO_TIMEOUT = 7000;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STORAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getKey(suffix) { return `habits_${clientId}_${suffix}`; }

function getHabits() {
    return JSON.parse(localStorage.getItem(getKey('habits')) || '[]');
}

function saveHabits(habits) {
    localStorage.setItem(getKey('habits'), JSON.stringify(habits));
}

function getCompletions() {
    return JSON.parse(localStorage.getItem(getKey('completions')) || '{}');
}

function saveCompletions(data) {
    localStorage.setItem(getKey('completions'), JSON.stringify(data));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DATE HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatDate(d)   { return d.toISOString().split('T')[0]; }
function isToday(d)      { return formatDate(d) === formatDate(new Date()); }
function isFuture(d)     { return d > new Date(); }

function formatDateNice(d) {
    const today = new Date(); today.setHours(0,0,0,0);
    if (isToday(d)) return "Today ‚Ä¢ " + d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    if (formatDate(d) === formatDate(new Date(today.getTime()-86400000))) return "Yesterday";
    return d.toLocaleDateString('en-US',{weekday:'short', month:'short', day:'numeric'});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT & UI SETUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
    if (!clientId) {
        document.querySelector('.content').innerHTML = `
            <div style="padding:3rem; text-align:center; color:var(--color-text-sec);">
                <h2 style="color:var(--color-text);">Setup Required</h2>
                <p>Use link like: <code>?client=your-name</code></p>
            </div>`;
        return;
    }

    document.getElementById('clientName').textContent = clientName;
    updateDateDisplay();
    renderAll();

    // Theme from system
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.dataset.theme = 'dark';
        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è Light';
    }

    document.getElementById('themeToggle').onclick = () => {
        const current = document.documentElement.dataset.theme;
        document.documentElement.dataset.theme = current === 'dark' ? 'light' : 'dark';
        document.getElementById('themeToggle').textContent = current === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    };

    document.getElementById('newHabit').oninput = e => {
        document.getElementById('charCount').textContent = `${e.target.value.length} / 80`;
    };

    document.getElementById('newHabit').onkeypress = e => {
        if (e.key === 'Enter') addHabit();
    };
}

function goToToday() {
    currentDate = new Date();
    currentDate.setHours(0,0,0,0);
    updateDateDisplay();
    renderAll();
}

function changeDate(days) {
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
    renderAll();
}

function updateDateDisplay() {
    document.getElementById('currentDate').textContent = formatDateNice(currentDate);
    document.getElementById('nextBtn').disabled = isToday(currentDate) || isFuture(currentDate);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HABIT ACTIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addHabit() {
    const input = document.getElementById('newHabit');
    const name = input.value.trim();
    if (!name) return;

    let habits = getHabits();
    if (habits.some(h => h.name.toLowerCase() === name.toLowerCase())) {
        alert("You already have this habit.");
        return;
    }
    if (habits.length >= 12) {
        alert("Maximum 12 habits allowed.");
        return;
    }

    const habit = { id: Date.now(), name, order: habits.length };
    habits.push(habit);
    saveHabits(habits);

    input.value = '';
    document.getElementById('charCount').textContent = '0 / 80';

    renderAll();
}

function deleteHabit(id, e) {
    e.stopPropagation();
    if (!confirm("Delete habit and all its history?")) return;

    let habits = getHabits().filter(h => h.id !== id);
    habits.forEach((h,i) => h.order = i);
    saveHabits(habits);

    let comp = getCompletions();
    Object.values(comp).forEach(day => delete day[id]);
    saveCompletions(comp);

    renderAll();
}

function moveHabit(id, direction) {
    let habits = getHabits();
    const idx = habits.findIndex(h => h.id === id);
    if (idx === -1) return;

    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= habits.length) return;

    [habits[idx], habits[newIdx]] = [habits[newIdx], habits[idx]];
    habits.forEach((h,i) => h.order = i);
    saveHabits(habits);

    renderAll();
}

function toggleHabit(id, partial = false) {
    const dateKey = formatDate(currentDate);
    let comp = getCompletions();
    if (!comp[dateKey]) comp[dateKey] = {};

    const prev = comp[dateKey][id] ?? 0;
    let next = partial ? (prev === 1 ? 0 : 0.5) : (prev === 1 ? 0 : 1);

    if (prev === 0.5 && partial) next = 1; // cycle: 0 ‚Üí 0.5 ‚Üí 1 ‚Üí 0

    comp[dateKey][id] = next;
    saveCompletions(comp);

    // Remember for undo
    lastAction = { type: 'toggle', habitId: id, dateKey, prevValue: prev };
    showUndo();

    renderAll();
}

function showUndo() {
    const toast = document.getElementById('undoToast');
    toast.classList.add('show');

    const btn = document.getElementById('undoBtn');
    btn.onclick = () => {
        if (!lastAction) return;
        let comp = getCompletions();
        if (lastAction.prevValue === 0) {
            delete comp[lastAction.dateKey][lastAction.habitId];
        } else {
            comp[lastAction.dateKey][lastAction.habitId] = lastAction.prevValue;
        }
        saveCompletions(comp);
        lastAction = null;
        toast.classList.remove('show');
        renderAll();
    };

    setTimeout(() => {
        if (toast.classList.contains('show')) {
            toast.classList.remove('show');
            lastAction = null;
        }
    }, UNDO_TIMEOUT);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
    renderHabits();
    renderStats();
    renderMotivation();
}

function renderHabits() {
    const list = document.getElementById('habitsList');
    const habits = getHabits().sort((a,b) => a.order - b.order);
    const comp = getCompletions();
    const today = comp[formatDate(currentDate)] || {};

    if (habits.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:4rem 1rem; color:var(--color-text-sec);">
            <h3>No habits yet</h3>
            <p>Add your first habit below.</p>
        </div>`;
        return;
    }

    list.innerHTML = habits.map(h => {
        const val = today[h.id] ?? 0;
        const checked = val === 1;
        const partial = val === 0.5;

        return `
        <div class="habit-item" role="checkbox" tabindex="0"
             aria-checked="${checked ? 'true' : partial ? 'mixed' : 'false'}"
             onkeydown="if(event.key==='Enter'||event.key===' ') toggleHabit(${h.id})">

            <div class="habit-check-area">
                <input type="checkbox" class="habit-check" id="h${h.id}"
                    ${checked?'checked':''} onchange="toggleHabit(${h.id})">
                <label for="h${h.id}" class="checkmark"></label>
            </div>

            <span class="habit-name" style="${checked?'opacity:0.7;text-decoration:line-through':''}">
                ${h.name}
            </span>

            <button class="partial-btn ${partial?'active':''}"
                    onclick="event.stopPropagation(); toggleHabit(${h.id}, true)">
                ¬Ω
            </button>

            <div class="habit-actions">
                <button class="move-btn" onclick="event.stopPropagation(); moveHabit(${h.id}, -1)">‚Üë</button>
                <button class="move-btn" onclick="event.stopPropagation(); moveHabit(${h.id}, 1)">‚Üì</button>
                <button class="delete-btn" onclick="deleteHabit(${h.id}, event)">√ó</button>
            </div>
        </div>`;
    }).join('');
}

function renderStats() {
    const habits = getHabits();
    const comp = getCompletions();
    const todayKey = formatDate(currentDate);
    const today = comp[todayKey] || {};

    const total = habits.length;
    const completed = habits.filter(h => (today[h.id] ?? 0) === 1).length;
    const partials  = habits.filter(h => (today[h.id] ?? 0) === 0.5).length;
    const score = completed + partials * 0.5;
    const percent = total ? Math.round((score / total) * 100) : 0;

    // Streak (forgiving ‚Äì 80%+ counts)
    let streak = 0;
    let d = new Date();
    d.setHours(0,0,0,0);

    while (true) {
        const k = formatDate(d);
        const day = comp[k] || {};
        const dayScore = habits.reduce((s,h) => s + (day[h.id] ?? 0), 0);
        const dayPct = total ? dayScore / total : 0;

        if (dayPct >= 0.8) {
            streak++;
            d.setDate(d.getDate() - 1);
        } else {
            break;
        }
        if (streak > 400) break;
    }

    document.getElementById('stats').innerHTML = `
        <div class="stat-box">
            <div class="stat-number">${completed}/${total}</div>
            <div class="stat-label">Full Today</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">${percent}%</div>
            <div class="stat-label">Score</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">${streak}</div>
            <div class="stat-label">Streak</div>
        </div>
    `;
}

function renderMotivation() {
    const habits = getHabits();
    if (!habits.length) return;

    const comp = getCompletions();
    const todayKey = formatDate(currentDate);
    const today = comp[todayKey] || {};

    const full = habits.filter(h => today[h.id] === 1).length;
    const total = habits.length;

    let msg = '';

    if (full === total && total > 0) {
        msg = Math.random() > 0.5 ?
            "Perfect day! You're unstoppable." :
            "Everything checked off ‚Äî legendary!";
    } else if (full >= total * 0.8) {
        msg = "Almost perfect ‚Äî great effort today!";
    } else if (streak >= 5) {
        msg = `You're on fire ‚Äî ${streak} day streak! üî•`;
    } else if (full > 0) {
        msg = "Small wins add up. Keep going.";
    }

    document.getElementById('motivationMsg').textContent = msg;
}

// Start
init();
</script>
</body>
</html>
